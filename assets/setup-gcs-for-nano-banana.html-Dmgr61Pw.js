import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,a as n,o as t}from"./app-ibx1Fi7L.js";const e={};function l(h,s){return t(),a("div",null,[...s[0]||(s[0]=[n(`<h2 id="为什么要折腾-gcs" tabindex="-1"><a class="header-anchor" href="#为什么要折腾-gcs"><span>为什么要折腾 GCS？</span></a></h2><p>当你兴致勃勃地调用 Gemini/VertexAI 生图 API 时，突然发现一个残酷的现实：这货只支持两种图片输入方式。</p><table><thead><tr><th>方式</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>Base64 编码</strong></td><td>简单直接，无需额外配置</td><td>请求体巨大，传输慢，容易超时</td><td>小图片（&lt;1MB）快速测试</td></tr><tr><td><strong>GCS 图片链接</strong></td><td>请求体小，传输快，支持大图</td><td>需要配置 GCS，有学习成本</td><td>生产环境，大图片处理</td></tr></tbody></table><p>显然，除非你喜欢看到接口请求大到能当小说读，否则 GCS 就是你的救星。本文就是教你如何优雅地驯服这只&quot;云存储小兽&quot;。</p><h2 id="开始前的-装备检查" tabindex="-1"><a class="header-anchor" href="#开始前的-装备检查"><span>开始前的&quot;装备检查&quot;</span></a></h2><p>在开始这场与 GCS 的&quot;亲密接触&quot;之前，请确保你已经：</p><ul><li>🛠️ 安装并配置了 <code>gcloud</code> CLI（如果还没装，那就先去喝杯咖啡，回来再说）</li><li>🔑 拥有 Google Cloud 项目和服务账户（没有的话，Google 不会让你进门的）</li><li>📋 准备好你的项目信息：<code>{YOUR_GCP_PROJECT_ID}</code> 和 <code>{YOUR_SERVICE_ACCOUNT_EMAIL}</code></li></ul><blockquote><p><strong>温馨提示：</strong> 文档中的占位符 <code>{...}</code> 需要替换成你的真实信息，不然命令会&quot;装糊涂&quot;哦！</p></blockquote><h2 id="正式开始-调教-gcs" tabindex="-1"><a class="header-anchor" href="#正式开始-调教-gcs"><span>正式开始&quot;调教&quot;GCS</span></a></h2><h3 id="第一步-确认你的-身份证" tabindex="-1"><a class="header-anchor" href="#第一步-确认你的-身份证"><span>第一步：确认你的&quot;身份证&quot;</span></a></h3><p>首先，让我们确认一下 gcloud 是否认识你这个&quot;老朋友&quot;：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 查看当前配置</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">gcloud</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> config</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> list</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 查看认证状态  </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">gcloud</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> auth</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> list</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 切换到目标项目</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">gcloud</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> config</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> set</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> project</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> {YOUR_GCP_PROJECT_ID}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="第二步-给你的图片找个-豪宅" tabindex="-1"><a class="header-anchor" href="#第二步-给你的图片找个-豪宅"><span>第二步：给你的图片找个&quot;豪宅&quot;</span></a></h3><p>现在我们要创建一个存储桶（Bucket），想象它是一个超大的云端硬盘，专门用来放你的图片：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 创建存储桶（选择美国中部，延迟低，还便宜）</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">gsutil</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> mb</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> {YOUR_GCP_PROJECT_ID}</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -c</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> STANDARD</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -l</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> us-central1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> gs://{YOUR_BUCKET_NAME}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 设置公开只读权限（让全世界都能看到你的图片杰作）</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">gsutil</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> iam</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ch</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> allUsers:objectViewer</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> gs://{YOUR_BUCKET_NAME}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>小贴士：</strong> 为什么选 <code>us-central1</code>？因为它是 Google 的&quot;老家&quot;，速度快，价格美丽，生图 API 也住在这附近呢！</p></blockquote><h3 id="第三步-设计你的-图片豪宅-布局" tabindex="-1"><a class="header-anchor" href="#第三步-设计你的-图片豪宅-布局"><span>第三步：设计你的&quot;图片豪宅&quot;布局</span></a></h3><p>我们不能让图片们像无头苍蝇一样乱放，得给它们安排个&quot;豪华别墅式&quot;的目录结构。采用 <strong>日期 + 毫秒时间戳</strong> 的组合，既能按时间归档，又能避免重名冲突（除非你能在同一毫秒内生成两张图，那就太厉害了）：</p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-text"><span class="line"><span>gs://{YOUR_BUCKET_NAME}/</span></span>
<span class="line"><span>└── {PROJECT_PREFIX}/                      # 项目前缀</span></span>
<span class="line"><span>    ├── 20250831/                         # 日期目录</span></span>
<span class="line"><span>    │   ├── 1756636726921/               # 毫秒时间戳 session-id</span></span>
<span class="line"><span>    │   │   ├── input/                   # 输入文件</span></span>
<span class="line"><span>    │   │   ├── output/                  # 输出文件</span></span>
<span class="line"><span>    │   │   └── logs/                    # 日志文件</span></span>
<span class="line"><span>    │   └── 1756636845678/               # 另一个 session</span></span>
<span class="line"><span>    └── 20250901/                        # 下一天的目录</span></span>
<span class="line"><span>        └── 1756723200000/</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="第四步-开通-跨域通行证-cors-配置" tabindex="-1"><a class="header-anchor" href="#第四步-开通-跨域通行证-cors-配置"><span>第四步：开通&quot;跨域通行证&quot;（CORS 配置）</span></a></h3><p>想要让你的网站直接跟 GCS &quot;对话&quot;？那必须先办个&quot;跨域通行证&quot;！不然浏览器会把你的请求当作&quot;可疑分子&quot;拦下来。</p><p>创建一个 CORS 配置文件（就像给 GCS 写一份&quot;信任名单&quot;）：</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-json"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// docs/cors-config.json</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    &quot;origin&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: [</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;http://localhost:3000&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;https://localhost:3000&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;https://{YOUR_DOMAIN}&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">],</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    &quot;method&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: [</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;GET&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;POST&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;PUT&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;DELETE&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;HEAD&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;OPTIONS&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">],</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    &quot;responseHeader&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: [</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Content-Type&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Access-Control-Allow-Origin&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;x-goog-resumable&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">],</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    &quot;maxAgeSeconds&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3600</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后把这份&quot;信任名单&quot;交给 GCS：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 应用 CORS 配置（让 GCS 知道谁是&quot;自己人&quot;）</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">gsutil</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cors</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> set</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> docs/cors-config.json</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> gs://{YOUR_BUCKET_NAME}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 验证配置（确认 GCS 记住了你的要求）</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">gsutil</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cors</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> gs://{YOUR_BUCKET_NAME}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>解释一下 <code>maxAgeSeconds: 3600</code>：</strong> 这是告诉浏览器&quot;这个通行证有效期1小时&quot;，避免每次请求都要重新验证身份，就像办了年卡的健身房，刷卡进门更顺畅。</p></blockquote><h3 id="第五步-雇个-自动清洁工-生命周期管理" tabindex="-1"><a class="header-anchor" href="#第五步-雇个-自动清洁工-生命周期管理"><span>第五步：雇个&quot;自动清洁工&quot;（生命周期管理）</span></a></h3><p>生图这玩意儿，用完就扔是常事。但手动删文件？太LOW了！我们要让 GCS 自己当&quot;清洁工&quot;，3天后自动把临时图片清理掉，避免存储费用像失控的小怪兽一样疯长。</p><p>创建一个&quot;自动清理合同&quot;：</p><div class="language-json line-numbers-mode" data-highlighter="shiki" data-ext="json" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-json"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// docs/lifecycle-config.json</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  &quot;lifecycle&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    &quot;rule&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: [</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        &quot;action&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">          &quot;type&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Delete&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        },</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        &quot;condition&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">          &quot;age&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">          &quot;matchesPrefix&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: [</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;{PROJECT_PREFIX}/&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ]</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后让 GCS 签下这份&quot;清洁合同&quot;：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 应用生命周期规则（雇佣自动清洁工）</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">gsutil</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> lifecycle</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> set</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> docs/lifecycle-config.json</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> gs://{YOUR_BUCKET_NAME}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 验证配置（确认清洁工已上岗）</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">gsutil</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> lifecycle</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> gs://{YOUR_BUCKET_NAME}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>为什么是3天？</strong> 因为大部分生图任务在几分钟内就完成了，3天足够你把结果下载保存，之后继续占着空间就是浪费钱了！</p></blockquote><h3 id="第六步-试车-测试上传功能" tabindex="-1"><a class="header-anchor" href="#第六步-试车-测试上传功能"><span>第六步：试车！（测试上传功能）</span></a></h3><p>配置完了，该试试这套&quot;豪华配置&quot;能不能正常工作了：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 创建一个测试文件并上传（就像试驾新车一样）</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">SESSION_ID</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">$(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">node</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -e</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;console.log(Date.now())&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">gsutil</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cp</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> local-file.jpg</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> gs://{YOUR_BUCKET_NAME}/{PROJECT_PREFIX}/</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">$(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">date</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> +%Y%m%d</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">$SESSION_ID</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 测试公开访问（确认图片能被全世界看到）</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">curl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -I</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> https://storage.googleapis.com/{YOUR_BUCKET_NAME}/{PROJECT_PREFIX}/</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">$(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">date</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> +%Y%m%d</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">$SESSION_ID</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/file-name.jpg</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果看到 <code>200 OK</code>，恭喜你！GCS 已经被你成功&quot;驯服&quot;了！</p><h2 id="🎉-配置清单-检查一下是否都搞定了" tabindex="-1"><a class="header-anchor" href="#🎉-配置清单-检查一下是否都搞定了"><span>🎉 配置清单（检查一下是否都搞定了）</span></a></h2><table><thead><tr><th>配置项</th><th>值</th><th>状态</th></tr></thead><tbody><tr><td>项目</td><td>{YOUR_GCP_PROJECT_ID}</td><td>✅</td></tr><tr><td>存储桶</td><td>{YOUR_BUCKET_NAME}</td><td>✅</td></tr><tr><td>区域</td><td>us-central1</td><td>✅ 就近原则</td></tr><tr><td>访问权限</td><td>公开只读</td><td>✅ 全世界可见</td></tr><tr><td>CORS 缓存</td><td>1小时</td><td>✅ 减少延迟</td></tr><tr><td>自动删除</td><td>{PROJECT_PREFIX}/ 目录 3天后</td><td>✅ 省钱神器</td></tr></tbody></table><h2 id="🔗-你的图片-门牌号-格式" tabindex="-1"><a class="header-anchor" href="#🔗-你的图片-门牌号-格式"><span>🔗 你的图片&quot;门牌号&quot;格式</span></a></h2><p>配置完成后，你的每张图片都会有一个独特的&quot;门牌号&quot;（URL）：</p><p><strong>标准格式：</strong></p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-text"><span class="line"><span>https://storage.googleapis.com/{YOUR_BUCKET_NAME}/{PROJECT_PREFIX}/{yyyyMMdd}/{timestamp}/文件名</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>实际长这样：</strong></p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-text"><span class="line"><span>https://storage.googleapis.com/example-app-storage/myapp/20250831/1756636726921/ai-generated-cat.jpg</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>这个 URL 就可以直接丢给 Gemini API 了，再也不用担心 Base64 把你的请求撑爆！</p><h2 id="🚀-实战-在-gemini-api-中使用-gcs-图片" tabindex="-1"><a class="header-anchor" href="#🚀-实战-在-gemini-api-中使用-gcs-图片"><span>🚀 实战：在 Gemini API 中使用 GCS 图片</span></a></h2><p>配置好 GCS 后，真正的魔法开始了！让我们看看如何在调用 Gemini/VertexAI 时优雅地传递 GCS 图片。</p><h3 id="实战开始" tabindex="-1"><a class="header-anchor" href="#实战开始"><span>实战开始</span></a></h3><h3 id="node-js-sdk-调用示例" tabindex="-1"><a class="header-anchor" href="#node-js-sdk-调用示例"><span>Node.js SDK 调用示例</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="shiki" data-ext="javascript" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-javascript"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 使用 GCS 图片的标准格式</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;"> imageInput</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  fileData</span><span style="--shiki-light:#0184BC;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    fileUri</span><span style="--shiki-light:#0184BC;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;gs://{YOUR_BUCKET_NAME}/{PROJECT_PREFIX}/20250831/1756636726921/input.jpg&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    mimeType</span><span style="--shiki-light:#0184BC;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;image/jpeg&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;"> contents</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [{</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  role</span><span style="--shiki-light:#0184BC;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;user&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  parts</span><span style="--shiki-light:#0184BC;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    { </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">text</span><span style="--shiki-light:#0184BC;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;请分析这张图片并生成一张类似风格的新图片&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> },</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    imageInput</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  ]</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;"> response</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> await</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> vertexAI</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">generateContent</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">contents</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="curl-调用示例" tabindex="-1"><a class="header-anchor" href="#curl-调用示例"><span>cURL 调用示例</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 使用 GCS 图片调用 VertexAI API</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">curl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -X</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> POST</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  -H</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;Authorization: Bearer $(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">gcloud</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> auth print-access-token)&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  -H</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;Content-Type: application/json&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  &quot;https://us-central1-aiplatform.googleapis.com/v1/projects/{YOUR_GCP_PROJECT_ID}/locations/us-central1/publishers/google/models/gemini-2.5-flash-image-preview:generateContent&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  -d</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;{</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;contents&quot;: [{</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      &quot;role&quot;: &quot;user&quot;,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      &quot;parts&quot;: [</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        {&quot;text&quot;: &quot;请分析这张图片&quot;},</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        {</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">          &quot;fileData&quot;: {</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;fileUri&quot;: &quot;gs://{YOUR_BUCKET_NAME}/{PROJECT_PREFIX}/20250831/1756636726921/input.jpg&quot;,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &quot;mimeType&quot;: &quot;image/jpeg&quot;</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">          }</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        }</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      ]</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    }]</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  }&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="关键要点" tabindex="-1"><a class="header-anchor" href="#关键要点"><span>关键要点</span></a></h3><ul><li><strong>fileUri 格式</strong>：必须是 <code>gs://</code> 开头的完整 GCS 路径</li><li><strong>mimeType 必填</strong>：告诉 Gemini 这是什么类型的图片</li><li><strong>权限要求</strong>：确保服务账户对 GCS 存储桶有读取权限</li></ul><blockquote><p><strong>Pro Tip：</strong> 使用 GCS 链接时，图片会被自动压缩到最大 3072x3072 分辨率，既保证质量又控制处理时间！</p></blockquote><h2 id="📝-占位符-翻译手册" tabindex="-1"><a class="header-anchor" href="#📝-占位符-翻译手册"><span>📝 占位符&quot;翻译手册&quot;</span></a></h2><p>看到文档中的 <code>{...}</code> 了吗？这些都是需要你&quot;填空&quot;的地方：</p><table><thead><tr><th>占位符</th><th>含义</th><th>参考示例</th></tr></thead><tbody><tr><td><code>{YOUR_GCP_PROJECT_ID}</code></td><td>你的 GCP 项目 ID</td><td><code>my-ai-project-2025</code></td></tr><tr><td><code>{YOUR_SERVICE_ACCOUNT_EMAIL}</code></td><td>服务账户邮箱</td><td><code>ai-bot@my-project.iam.gserviceaccount.com</code></td></tr><tr><td><code>{YOUR_BUCKET_NAME}</code></td><td>存储桶名称</td><td><code>my-nanobana-images</code></td></tr><tr><td><code>{YOUR_DOMAIN}</code></td><td>你的网站域名</td><td><code>myapp.vercel.app</code></td></tr><tr><td><code>{PROJECT_PREFIX}</code></td><td>项目文件夹名</td><td><code>nb</code></td></tr></tbody></table><blockquote><p><strong>记住：</strong> 这些只是示例，请替换成你自己的真实信息！不然 GCS 会一脸懵逼地看着你。</p></blockquote>`,60)])])}const k=i(e,[["render",l]]),r=JSON.parse('{"path":"/llm/setup-gcs-for-nano-banana.html","title":"让 Nano-Banana 生图不再\\"吃内存\\"：GCS 集成攻略","lang":"zh-CN","frontmatter":{"title":"让 Nano-Banana 生图不再\\"吃内存\\"：GCS 集成攻略","date":"2025-08-31T00:00:00.000Z","category":["开发"],"tag":["Google Cloud","GCS","VertexAI","Gemini","Nano-Banana"],"excerpt":"为 Nano‑Banana 集成 GCS，提供高效稳定的大图输入方案与生产级配置清单（CORS、生命周期、目录规范等）。","cover":"/covers/setup-gcs-for-nano-banana.jpg","description":"为什么要折腾 GCS？ 当你兴致勃勃地调用 Gemini/VertexAI 生图 API 时，突然发现一个残酷的现实：这货只支持两种图片输入方式。 显然，除非你喜欢看到接口请求大到能当小说读，否则 GCS 就是你的救星。本文就是教你如何优雅地驯服这只\\"云存储小兽\\"。 开始前的\\"装备检查\\" 在开始这场与 GCS 的\\"亲密接触\\"之前，请确保你已经： 🛠️...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"让 Nano-Banana 生图不再\\\\\\"吃内存\\\\\\"：GCS 集成攻略\\",\\"image\\":[\\"https://gumutianqi.github.io/covers/setup-gcs-for-nano-banana.jpg\\"],\\"datePublished\\":\\"2025-08-31T00:00:00.000Z\\",\\"dateModified\\":\\"2025-08-31T18:51:51.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"古老师 (LarryKoo)\\",\\"url\\":\\"https://gumutianqi.github.io\\",\\"email\\":\\"larry.koo711@gmail.com\\"}]}"],["meta",{"property":"og:url","content":"https://gumutianqi.github.io/llm/setup-gcs-for-nano-banana.html"}],["meta",{"property":"og:site_name","content":"古老师的博客"}],["meta",{"property":"og:title","content":"让 Nano-Banana 生图不再\\"吃内存\\"：GCS 集成攻略"}],["meta",{"property":"og:description","content":"为什么要折腾 GCS？ 当你兴致勃勃地调用 Gemini/VertexAI 生图 API 时，突然发现一个残酷的现实：这货只支持两种图片输入方式。 显然，除非你喜欢看到接口请求大到能当小说读，否则 GCS 就是你的救星。本文就是教你如何优雅地驯服这只\\"云存储小兽\\"。 开始前的\\"装备检查\\" 在开始这场与 GCS 的\\"亲密接触\\"之前，请确保你已经： 🛠️..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://gumutianqi.github.io/covers/setup-gcs-for-nano-banana.jpg"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-08-31T18:51:51.000Z"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"https://gumutianqi.github.io/covers/setup-gcs-for-nano-banana.jpg"}],["meta",{"name":"twitter:image:alt","content":"让 Nano-Banana 生图不再\\"吃内存\\"：GCS 集成攻略"}],["meta",{"property":"article:tag","content":"Nano-Banana"}],["meta",{"property":"article:tag","content":"Gemini"}],["meta",{"property":"article:tag","content":"VertexAI"}],["meta",{"property":"article:tag","content":"GCS"}],["meta",{"property":"article:tag","content":"Google Cloud"}],["meta",{"property":"article:published_time","content":"2025-08-31T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-08-31T18:51:51.000Z"}]]},"git":{"createdTime":1756666311000,"updatedTime":1756666311000,"contributors":[{"name":"gujianguo","username":"gujianguo","email":"gujianguo@meiqia.com","commits":1,"url":"https://github.com/gujianguo"}]},"readingTime":{"minutes":6.06,"words":1817},"filePathRelative":"llm/setup-gcs-for-nano-banana.md","autoDesc":true}');export{k as comp,r as data};
